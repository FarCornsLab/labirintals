# Клиент-сервер API
## Подключение к серверу и отправка JSON строки
Сервер использует socket для отпрваки и принятия JSON.

JSON отправляется строкой, символ "\n" является признаком окончания JSON строки

### Пример подключения к серверу, отправки и принятия json команды (Python)
    import socket
    import json

    ip = "127.0.0.1"
    port = 9999
    sock = socket.socket()
    sock.connect((ip,port))

    json_cmd = {"cmd":"connect","params"{"name":"player_name"}}

    json_str = json.dumps(json_cmd)
    json_str += "\n"
    bytes = json_str.encode()
    self.sock.sendall(bytes)

    json_str = ""
    buf = sock.recv(self.buf_size)
    json_str += buf.decode()
    while buf[len(buf)-1] != ord("\n"):
        buf = sock.recv(self.buf_size)
        if(len(buf) > 0):
            json_str += buf.decode()
    json_answ = json.loads(json_str)
    print(jason_answ)

## Базовый синтаксис команды
### Команды от клиента

    {
        "cmd": "get_server_list",
        "params": {
            ...
        }
    }

### Команды от сервера

    {
        "cmd": "get_server_list",
        "params": {
            ...
        },
        "error": {
            ...
        }
    }

* `cmd` (string) - команда серверу, описание команд и их параметры см. ниже;
* `params` - обьект с параметрами команды. Не должно указываться в случае отсутствия параметров;
* `error` (`error`) - поле ошибки типа `error` (см. ниже). Является необязательное, в случе отсутствия ошибки.
   
## Базовые модели данных

#### `player`:
Структура описания игрока.  
Поля:
* `name` (string) - имя игрока;
* `oid` (string) - общедоступный id игрока.

#### `position`:
Структура определяющая unit на поле.  
Поля:
* `x` (int) - x координата;
* `y` (int) - y координата.

#### `player_position`:
Структура описывающая положение игрока на карте.  
Поля:
* `player` (`player`) - игрок;
* `position` (`position`) - общедоступный id игрока.

#### `map`:
Структура описывающая карту в n строк и m столбцов, а также положение игроков на ней.
Поля:
* `horizontal_border` ([[`string`]]) - двумерный массив размером n + 1 на m описывающий горизонтальные границы c верху в низ по первому измерению и с лева на право во втором измерении. Каждый элемент которого может принять одно из следующих значений:
    * `free` - проход свободен;
    * `obstacle` - проход закрыт;
    * `exit` - выход из лабиринта;
* `vertical_border` ([[`string`]]) - двумерный массив размером n на m + 1 описывающий вертикальные границы с лева на провао по первому измерению и с верху в низ во втором измерении. Каждый элемент которого может принять одно из следующих значений: `free`, `obstacle`, `exit`;
* `players_position` ([`player_position`]) - массив расположения игроков на карте. Отсчёт начинается с верхнего левого угла, который имеет координаты `x` = 0, `y` = 0. Ось `x` направленна горизонтально в право, `y` - вертикаольно в низ.

#### `error`:
Структура описывающая ошибку.
Поля:
* `code` (int) - код ошибки;
* `message` (string) - сообщение об ошибке.

## Команды начала игры


#### `connection`:
Присоединение к игре. Отправляется без поля `cid`.  
От: `client`.  
Параметры:  
* `name` (string) - имя присоединяемого клиента.  

Ответ: `connection_answer`.  
Пример запроса:

    {
        "cmd": "connection",
        "params": {
            "name": "Bender Bending Rodríguez"
        }
    }

#### `connection_answer`:
Ответ на присоединение к игре.  
От: `server`.  
Параметры:  
* `player`(Player) - инфа о об игроке, если получилось присоедениться. 

Пример ответа:

    {
        "cmd": "connection_answer",
        "params": {
            "player": {
                "name": "Bender Bending Rodríguez",
                "oid": "dsdsdk-0ds0dsv-sdsd0v-eew21d"
             },
        }
    }

#### `disconnect`:
Отключение от сервера.  
От: `client`.  
Параметры:  
* нет

Ответ: `connection_answer`.  
Пример запроса:

    {
        "cmd": "connection",
        "params": {
            "name": "Bender Bending Rodríguez"
        }
    }

#### `disconnect_answer`:
Ответ на отключение от сервера.
От: `server`.  
Параметры:  
* `success` - True если успешно 

Пример ответа:
    {
        "cmd": "disconnect_answer",
        "params": {
            "success": true
        }
    }

#### `get_game_params`:
Получение параметров игры.  
От: `client`.  
Ответ: `game_params`.  
Пример запроса:

    {
        "cmd": "get_game_params"
    }

#### `game_params`:
Описывает параметры игры.  
От: `server`.
Параметры:  
* `start_time` (uint64) - время начала игры в миллисекундах UNIX time, в случае если равно 0 - оно ещё не известно;
* `step_time` (int) - время отведённое на 1 ход в секундах;
* `players` ([`player`]) - массив игроков, присоеденённых к игре.

Пример ответа:

    {
        "cmd": "game_params",
        "params": {
            "start_time": 1609164794,
            "step_time": 1200,
            "players": [{
                "name": "Bender Bending Rodríguez",
                "oid": "dsdsdk-0ds0dsv-sdsd0v-eew21d"
            }, {
                "name": "Philip Jay Fry",
                "oid": "dsds123k-0d111sv-sghg223-eew21d"
            }]
        }
    }

### Процесс игры
#### `make_step`:
Уведомляет сервер о намерении сделать шаг. Также, способна изменить уже выбранны шаг при благоприятных условиях.  
От: `client`.   
Параметры: 
* `step_id` (int) - номер шага, отсчёт с 1;
* `step_type` (string) - тип шага. Допустимые значения: `up`, `right`, `down`, `left`.

Ответ: `step_answer`.

#### `step`:
Просит информацию о текущем шаге.  
От: `client`.  
Ответ: `step_answer`.  

#### `step_answer`:
Уведомляет игрока об последнем шаге.  
От: `server`.  
Параметры:  
* `step_id` (int) - номер текущего шага. Нумерация производится с 1. Возможные специальные значения:
    * 0  - игра не началась;
    * -1 - игра завершилась;
* `set_step_type` (string) - тип последнего успешно установленного шага, может принимать следующие значения: `up`, `right`, `down`, `left`, `null`;
* `step_end_time` (long) - время окончания хода в UNIX.

#### `get_position`:
Запрашивает у сервера положение игрока.  
От: `client`.  
Ответ: `position`.  

#### `position`:
Возвращает позицию игрока.  
От: `server`.  
Параметры:  
* `step_id` (int) - номер текущего шага. Нумерация производится с 1. Возможные специальные значения:
    * 0  - игра не началась;
    * -1 - игра завершилась;
* `field_unit` [`string`] - массив из 4х элементов описывающий положение игрока. Описание начинается с верхней границы и происходит по часовой стрелке. Каждый элемент массива может принимать одно из следующих значений:
    * `free` - проход свободен;
    * `obstacle` - проход закрыт;
    * `exit` - выход из лабиринта
* `next_step_time` (long) - время следующего хода
    
Пример ответа:

    {
        "cmd": "position",
        "params": {
            "step_id": 1,
            "field_unit": [
                "obstacle",
                "exit",
                "free",
                "obstacle"
            ]
        }
    }

Пояснения:
Данный пример описывает положение игрока на 1 ходу, находящегося в следующей клетке:

    +---+
    |   :
    +   +
    
, где:
* `---` - горизонтальная граница;
* `   ` - свободный горизонтальный проход;
* `|` - вертикальная граница;
* ` ` - свободный вертикальный проход;
* `. .` - горизонтальная выход из лабиринта;
* `:` - вертикальный выход из лабиринта.

### Завершение игры
#### `get_game_result`:
Запрашивает результаты игры.  
От: `client`.  
Ответ: `game_result`.  

#### `game_result`:
Возвращает результаты игры.  
От: `server`.  
Параметры: 
* `winners` ([`player`]) - массив, описывающие игроков, одержавших победу;
* `step_id`(`int`) - номер шага, на котором была одержана победа;
* `map` (`map`) - карта игры (не содержит игроков одержавших победу).

Пример ответа:

    {
        "cmd": "game_result",
        "params": {
            "winners": [{
                "name": "Bender Bending Rodríguez",
                "oid": 2716057
            }],
            "step_id": 140,
            "map": {
                "horizontal_border": [
                    ["obstacle", "free"],
                    ["free", "obstacle"],
                    ["free", "free"],
                    ["obstacle", "obstacle"]
                ],
                "vertical_border": [
                    ["obstacle", "obstacle", "obstacle"],
                    ["obstacle", "obstacle", "free"],
                    ["free", "obstacle", "exit"]
                ],
                "players_position": {
                    "player": {
                        "name": "Philip Jay Fry",
                        "oid": 13194894195
                    },
                    "position": {
                        "x": 0,
                        "y": 1
                    }
                }
            },
        }
    }
    
Пояснения:  
Данный пример описывает лабиринт размерностью 3 на 2 имеющий следующий вид:

    +---+
    |   |
    +   +---+
    | * |   |
    +   +   +
    |       :
    +---+---+
    
, где:
* `---` - горизонтальная граница;
* `   ` - свободный горизонтальный проход;
* `|` - вертикальная граница;
* ` ` - свободный вертикальный проход;
* `. .` - горизонтальная выход из лабиринта;
* `:` - вертикальный выход из лабиринта;
* `*` - позиция игрока с `oid` = `"dsdsdk-0ds0dsv-sdsd0v-eew21d"`.

Игрок с `oid` = `"dsdsdk-0ds0dsv-sdsd0v-css3212` не передаётся в поле `map`, так как данный игрок вышел из лабиринта.
